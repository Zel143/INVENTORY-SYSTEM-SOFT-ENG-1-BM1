// ======================================
// FIREBASE SECURITY RULES
// Arthur's Implementation - Governance Layer
// ======================================
// These rules enforce role-based access control and
// create an immutable audit trail to prevent the
// "Shared Spreadsheet" collapse risk.
// ======================================

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ======================================
    // HELPER FUNCTIONS
    // ======================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check for Admin role
    // Reads from users collection to verify role
    function isAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is Staff or Admin
    function isStaffOrAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['staff', 'admin'];
    }
    
    // ======================================
    // INVENTORY COLLECTION
    // ======================================
    // Document ID: Item_Code (e.g., "MCH-001")
    // Fields: description, vendor, current_stock, allocated_stock,
    //         min_threshold, max_ceiling, date_delivered,
    //         warranty_start, warranty_end, storage_location, image
    
    match /inventory/{item} {
      // READ: Everyone authenticated can read inventory
      allow read: if isAuthenticated();
      
      // CREATE/DELETE: Only Admins can create new items or delete items
      allow create, delete: if isAdmin();
      
      // UPDATE: 
      // - Staff can ONLY update current_stock and allocated_stock
      // - Admins can update ANY field
      // - NO ONE can set negative stock values
      allow update: if isAuthenticated() && 
                    (
                      // Staff: can only change stock fields
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['current_stock', 'allocated_stock']) &&
                       request.resource.data.current_stock >= 0 &&
                       request.resource.data.allocated_stock >= 0) 
                      ||
                      // Admin: can change any field (including thresholds)
                      isAdmin()
                    );
    }
    
    // ======================================
    // TRANSACTIONS COLLECTION (The "Black Box")
    // ======================================
    // Document ID: Auto-generated
    // Fields: item_id (reference), item_name, actor_id, quantity_change,
    //         timestamp, destination, purpose
    //
    // CRITICAL: This collection is IMMUTABLE after creation
    // This ensures audit trail integrity - no one can erase history
    
    match /transactions/{id} {
      // CREATE: Any authenticated user can create transaction records
      allow create: if isAuthenticated() &&
                    request.resource.data.keys().hasAll([
                      'item_id', 'item_name', 'actor_id', 'quantity_change',
                      'timestamp', 'destination', 'purpose'
                    ]) &&
                    request.resource.data.actor_id == request.auth.uid &&
                    request.resource.data.quantity_change is int &&
                    request.resource.data.quantity_change != 0;
      
      // READ: Only Admins can read full transaction history
      // This protects sensitive "Saan Napunta" data
      allow read: if isAdmin();
      
      // UPDATE/DELETE: Explicitly FORBIDDEN for everyone (including admins)
      // This creates the immutable "Black Box" for financial accountability
      allow update, delete: if false;
    }
    
    // ======================================
    // ALLOCATION LOGS COLLECTION
    // ======================================
    // Document ID: Auto-generated
    // Fields: item_id (reference), reserved_quantity, project_reference,
    //         status ("Active" or "Released"), user_id, created_at
    //
    // Purpose: Track maintenance agreements (MA) and reserved stock
    
    match /allocation_logs/{id} {
      // READ: All authenticated users can read allocation logs
      allow read: if isAuthenticated();
      
      // WRITE (create, update, delete): Only Admins can manage allocations
      // This prevents staff from "releasing" reserved stock without authorization
      allow write: if isAdmin() &&
                   request.resource.data.keys().hasAll([
                     'item_id', 'reserved_quantity', 'project_reference',
                     'status', 'user_id', 'created_at'
                   ]) &&
                   request.resource.data.status in ['Active', 'Released'] &&
                   request.resource.data.reserved_quantity > 0;
    }
    
    // ======================================
    // USERS COLLECTION (Role Management)
    // ======================================
    // Document ID: Firebase Auth UID
    // Fields: email, role, displayName, createdAt
    //
    // This collection stores user roles for security rule checks
    
    match /users/{userId} {
      // READ: Users can read their own profile; Admins can read all
      allow read: if isAuthenticated() && 
                   (request.auth.uid == userId || isAdmin());
      
      // CREATE: New users can create their own profile (default role: staff)
      allow create: if isAuthenticated() && 
                    request.auth.uid == userId &&
                    request.resource.data.role == 'staff' &&
                    request.resource.data.keys().hasAll(['email', 'role', 'displayName', 'createdAt']);
      
      // UPDATE: Only Admins can change user roles
      allow update: if isAdmin();
      
      // DELETE: Only Admins can delete users
      allow delete: if isAdmin();
    }
    
    // ======================================
    // DAILY SUMMARIES COLLECTION (Admin Analytics)
    // ======================================
    // Document ID: Date in YYYY-MM-DD format
    // Fields: burn_rate, destination_breakdown, critical_items,
    //         total_transactions, generated_at
    
    match /daily_summaries/{date} {
      // READ: Only Admins can view daily summaries
      allow read: if isAdmin();
      
      // WRITE: Only Cloud Functions can write (set service account permissions separately)
      allow write: if false; // Will be modified for Cloud Functions service account
    }
    
    // ======================================
    // DENY ALL OTHER COLLECTIONS
    // ======================================
    // Explicitly deny access to any undefined collections
    // This follows the "deny by default" security principle
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// ======================================
// BUSINESS VIABILITY NOTES
// ======================================
//
// 1. RISK MITIGATION (Audit Integrity):
//    The transactions rule creates an immutable "Black Box" where records
//    cannot be edited or deleted by anyone, including admins. This ensures
//    that if inventory goes missing, the digital trail cannot be "erased"
//    to cover losses, guaranteeing financial accountability.
//
// 2. OPERATIONAL CONTROL:
//    By restricting min_threshold and max_ceiling updates to Admin roles,
//    staff cannot artificially lower alert thresholds to hide stockout risks.
//    This prevents the "hide the problem" scenario where red alerts are
//    suppressed rather than addressed.
//
// 3. TRUST AND RELIABILITY:
//    Floor staff can confidently use the system knowing their actions are
//    protected by "Software Safety Rails" - they can't accidentally delete
//    entire item records while updating quantities. This reduces training
//    burden and operational anxiety.
//
// 4. DASHBOARD PRECISION:
//    Admin dashboards display authentic, untampered data because security
//    rules guarantee data integrity at the database level, not just the UI.
//    This enables accurate procurement decisions based on trustworthy data.
//
// SYSTEM COLLAPSE FACTOR:
// Without these rules, the database becomes a "Shared Spreadsheet" where:
// - Staff can delete transaction history to hide mistakes
// - Anyone can lower thresholds to stop alerts
// - Audit trails can be manipulated
// - Trust between warehouse floor and administrative audit collapses
// - Financial accountability becomes impossible
//
// ======================================
// DEPLOYMENT INSTRUCTIONS
// ======================================
//
// 1. Via Firebase Console (Quick):
//    - Go to Firestore Database â†’ Rules tab
//    - Copy this entire file content
//    - Paste and click "Publish"
//
// 2. Via Firebase CLI (Recommended):
//    - Run: firebase deploy --only firestore:rules
//
// 3. Create Initial Admin User:
//    After deploying rules, create an admin user in the users collection:
//    
//    Document ID: <Firebase Auth UID>
//    Fields: {
//      email: "admin@yourdomain.com",
//      role: "admin",
//      displayName: "System Administrator",
//      createdAt: <timestamp>
//    }
//
// 4. Testing:
//    Use Firebase Emulator to test rules before production:
//    - firebase emulators:start --only firestore
//    - Test staff permissions (should fail on threshold changes)
//    - Test admin permissions (should succeed on all operations)
//    - Test transaction immutability (updates should fail for everyone)
